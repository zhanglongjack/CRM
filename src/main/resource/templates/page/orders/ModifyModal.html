<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" 
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
	<title>test</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

</head>

<body>
	<div th:fragment="dialog-content">
<script type="text/javascript">
	$(function(){
		initTimePicker();
	})
</script>
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
							&times;
						</button>
						<h4 class="modal-title" id="ModifyModalTitle">
							填写订单信息
						</h4>
					</div>
					<div class="modal-body">
						<form id="modifyDataFrom" class="form-horizontal" role="form">
							<input id="modifyId" name="orderNo" type="hidden" th:attr="value=${modifyOrder==null}?'':${modifyOrder.orderNo}">
							<input id="userId" name="userId" type="hidden" th:attr="value=${session.user.uId}">
							<input id="modifyModel" name="modifyModel" type="hidden" th:attr="value=${modifyModel==null}?'':${modifyModel}">
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">客户微信</label> 
								<div class="col-sm-9">
									<input type="text" class="form-control"  placeholder="客户微信号" name="oWechatNo" 
										th:attr="value=${modifyOrder==null}?'':${modifyOrder.oWechatNo}">
								</div>
							</div>
							
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">下单日期</label> 
								<div class="col-sm-9">
									<span class="input-group input-append date" id="datepicker">
										<input readonly type="text" class="form-control" name="orderDate"
                                            placeholder="yyyymmdd" data-date-format="yyyymmdd" 
                                            th:attr="value=${modifyOrder==null}?${#dates.format(#dates.createNow(), 'yyyyMMdd')}:${modifyOrder.orderDate}">
                                         <span class="input-group-addon add-on">
                                            <i class="glyphicon glyphicon-calendar"></i>
                                         </span>
									</span>
								</div>
							</div>
							<div class="clearfix"></div>
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">联系人</label> 
								<div class="col-sm-9">
									<input type="text" class="form-control"  placeholder="联系人" name="contact" 
										th:attr="value=${modifyOrder==null}?'':${modifyOrder.contact}">
								</div>
							</div>
							
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">电话</label> 
								<div class="col-sm-9">
									<input type="text" class="form-control"  placeholder="电话" name="oPhone" 
										th:attr="value=${modifyOrder==null}?'':${modifyOrder.oPhone}">
								</div>
							</div>
							
							<div class="clearfix"></div>
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">订单状态</label> 
								<div class="col-sm-9">
									<select class="form-control" name="orderStatus" th:if="${modifyOrder==null}">
										<option th:each="orderStatus:${orderStatusMap}" 
												th:value="${orderStatus.key}" th:text="${orderStatus.value}">
										</option>
									</select>
									<select class="form-control" name="orderStatus" th:if="${modifyOrder!=null}">
										<option th:each="orderStatus:${orderStatusMap}" 
												th:selected="${modifyOrder.orderStatus == orderStatus.key}" 
												th:value="${orderStatus.key}" th:text="${orderStatus.value}">
										</option>
									</select>
								</div>
							</div>
							
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">付款方式</label> 
								<div class="col-sm-9">
									<select class="form-control" name="paymentMethod">
										<option th:each="map:${session.paymentMethodMap}" th:selected="${modifyOrder!=null&&modifyOrder.paymentMethod == map.key}" 
												th:value="${map.key}" th:text="${map.value}"></option>
									</select>
								</div>
							</div>

							<div class="clearfix"></div>
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">总金额</label> 
								<div class="col-sm-9">
									<input type="text" class="form-control"  placeholder="0.00" name="totalAmt" 
										th:attr="value=${modifyOrder==null}?'':${modifyOrder.totalAmt}">
								</div>
							</div>
							
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">折后金额</label> 
								<div class="col-sm-9">
									<input type="text" class="form-control"  placeholder="0.00" name="afterDiscountAmt" 
										th:attr="value=${modifyOrder==null}?'':${modifyOrder.afterDiscountAmt}">
								</div>
							</div>
							<div class="clearfix"></div>
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">定金</label> 
								<div class="col-sm-9">
									<input type="text" class="form-control"  placeholder="0.00" name="deposits" 
										th:attr="value=${modifyOrder==null}?'':${modifyOrder.deposits}">
								</div>
							</div>
							
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">到付金额</label> 
								<div class="col-sm-9">
									<input type="text" class="form-control"  placeholder="0.00" name="cashOnDeliveryAmt" 
										th:attr="value=${modifyOrder==null}?'':${modifyOrder.cashOnDeliveryAmt}">
								</div>
							</div>
							<div class="clearfix"></div>
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">会员余额</label> 
								<div class="col-sm-9">
									<input readonly type="text" class="form-control"  placeholder="0.00" name="userAmt"
										th:attr="value=${modifyOrder!=null&&modifyOrder.custInfo!=null}?${modifyOrder.custInfo.amt}:''">
								</div>
							</div>
							
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">实付金额</label> 
								<div class="col-sm-9">
									<input readonly type="text" class="form-control"  placeholder="0.00" name="payAmount" 
										th:attr="value=${modifyOrder==null}?'':${modifyOrder.payAmount}">
								</div>
							</div>
							<div class="clearfix"></div>
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">快递单号</label> 
								<div class="col-sm-9">
									<input type="text" class="form-control"  placeholder="快递单号" name="expressNo" 
										th:attr="value=${modifyOrder==null}?'':${modifyOrder.expressNo}">
								</div>
							</div>
							
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">快递公司</label> 
								<div class="col-sm-9">
									<input type="text" class="form-control"  placeholder="快递公司" name="expressCompany" 
										th:attr="value=${modifyOrder==null}?'':${modifyOrder.expressCompany}">
								</div>
							</div>
							
							<div class="clearfix"></div>
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">产品列表</label> 
								<div class="col-sm-9">
										<textarea name="productList" class="form-control" rows="3" 
										placeholder="产品列表信息" th:text="${modifyOrder==null}?'':${modifyOrder.productList}"></textarea>
								</div>
							</div>
							
							<div class="form-group col-sm-6">
								<label class="col-sm-3 control-label">地址</label> 
								<div class="col-sm-9">
									<input type="text" class="form-control"  placeholder="地址" name="address" 
										th:attr="value=${modifyOrder==null}?'':${modifyOrder.address}">
								</div>
							</div>
							<div class="clearfix"></div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">关闭
						</button>
						<button type="button" class="btn btn-primary" id="ModifyModalSubmit">
							提交
						</button>
					</div>
	</div>
</body>
<script th:inline="javascript">
/*<![CDATA[*/
	var modifyOrder = /*[[${modifyOrder}]]*/;
/*]]>*/
</script>
<script type="text/javascript">

	$(document).ready(function() {
		
		$("#ModifyModal").on("hidden.bs.modal", function() {  
		    $(this).removeData("bs.modal");  
		}); 
		var discount = null;
		if(modifyOrder){
			discount = modifyOrder.custInfo.levelInfo.lDiscount;
		}
		function computeDscount(value){
			if(discount && discount!=null&&value){
            	var afterDiscountAmt = value * discount;
            	$("#ModifyModal").find('.modal-body input[name="afterDiscountAmt"]').val(afterDiscountAmt);
        	}
		}
		
		
	    $('#modifyDataFrom').bootstrapValidator({
	        message: '输入无效,请重新输入',
	        group:'.form-group',
	        feedbackIcons: {
	            valid: 'glyphicon glyphicon-ok',
	            invalid: 'glyphicon glyphicon-remove',
	            validating: 'glyphicon glyphicon-refresh'
	        },
	        fields: {
	        	oWechatNo: {
	                message: '客户微信号输入无效',
	                validators: {
	                    notEmpty: {
	                        message: '客户微信号不能为空'
	                    },
	                    callback: {
	                        message: '客户微信号不存在,请添加客户信息或查证后再录入',
	                        callback:function(value, validator,$field){
	                        	var exists= false;
	                        	var params = {oWechatNo:value+""};
	                        	$.ajax({
	                        		url: checkWechatNoURL,
	                        		data:params,
	                        		type: 'get',
	                        		cache : false,
	                        		async : false,
	                        		dataType: 'json',
	                        		success: function(data) {
	                        			exists = data!=null;
	                        			if(exists){
	                        				discount = data.levelInfo.lDiscount;
	                        				$("#ModifyModal").find('.modal-body input[name="contact"]').val(data.custName);
	                        				$("#ModifyModal").find('.modal-body input[name="address"]').val(data.address);
	                        				$("#ModifyModal").find('.modal-body input[name="oPhone"]').val(data.custPhone);
	                        				$("#ModifyModal").find('.modal-body input[name="userAmt"]').val(data.amt.toFixed(2));
	                        				var totalAmt = $("#ModifyModal").find('.modal-body input[name="totalAmt"]').val();
	                        				
	                        				var bootstrapValidator = $("#modifyDataFrom").data("bootstrapValidator");
	                        				bootstrapValidator.updateStatus('contact', 'NOT_VALIDATED').validateField('contact'); 
	                        				bootstrapValidator.updateStatus('address', 'NOT_VALIDATED').validateField('address'); 
	                        				bootstrapValidator.updateStatus('oPhone', 'NOT_VALIDATED').validateField('oPhone'); 
	                        				computeDscount(totalAmt);
	                        				
	                        			}
	                        		}
	                        	});
								return exists;
	                        }
	                    }
	                }
	            },
	        	contact: {
	                message: '联系人输入无效',
	                validators: {
	                    notEmpty: {
	                        message: '联系人不能为空'
	                    }
	                }
	            },
	            productList: {
	                message: '产品列表信息输入无效',
	                validators: {
	                    notEmpty: {
	                        message: '产品列表不能为空'
	                    }
	                }
	            },
	            address: {
	                message: '地址输入无效',
	                validators: {
	                    notEmpty: {
	                        message: '地址不能为空'
	                    }
	                }
	            },
	            userAmt: {
	                message: '会员余额异常',
                    callback: {
                        callback:function(value, validator,$field){
							
							return true;
                        }
                    }
	            },
	            totalAmt: {
	                message: '总金额输入无效',
	                validators: {
	                    notEmpty: {
	                        message: '总金额不能为空'
	                    },
	                    numeric: {message: '总金额只能输入数字'},
		                callback: {
	                        callback:function(value, validator,$field){
	                        	computeDscount(value);
								return true;
	                        }
	                    }
	                }
	            },
	            deposits: {
	                message: '定金输入无效',
	                validators: {
	                    numeric: {message: '定金只能输入数字'},
	                    callback: {
	                        callback:function(value, validator,$field){
								var userAmt = $("#ModifyModal").find('.modal-body input[name="userAmt"]').val();
								if(userAmt==0){
									
									return  {
				                        valid: false,
				                        message: '会员余额为0时,定金必填,且不可为0'
				                    };
								}
								return true;
	                        }
	                    }
	                }
	            },
	            cashOnDeliveryAmt: {
	                message: '到付金额输入无效',
	                validators: {
	                	numeric: {message: '到付金额只能输入数字'},
	                    callback: {
	                        callback:function(value, validator,$field){
								var userAmt = $("#ModifyModal").find('.modal-body input[name="userAmt"]').val();
								var afterDiscountAmt = $("#ModifyModal").find('.modal-body input[name="afterDiscountAmt"]').val();
								if(userAmt==0 && afterDiscountAmt==0){
									return  {
				                        valid: false,
				                        message: '会员余额为0时,到付金额必填,且不可为0'
				                    };
								}else if((userAmt-afterDiscountAmt)<0){
									//$("#ModifyModal").find('.modal-body input[name="cashOnDeliveryAmt"]').val(afterDiscountAmt - userAmt);
									return  {
				                        valid: value >= afterDiscountAmt - userAmt ,
				                        message: '会员余额不足时,到付金额必填,且到付金额=折扣金额-会员余额'
				                    };
								}
								
								return true;
	                        }
	                    }
	                }
	            },
	            afterDiscountAmt: {
	                message: '折扣金额输入无效',
	                validators: {
	                	numeric: {message: '折扣只能输入数字'},
	                    callback: {
	                        callback:function(value, validator,$field){
								var userAmt = $("#ModifyModal").find('.modal-body input[name="userAmt"]').val();
								var afterDiscountAmt = $("#ModifyModal").find('.modal-body input[name="afterDiscountAmt"]').val();
								var bootstrapValidator = $("#modifyDataFrom").data("bootstrapValidator");
								if(userAmt==0 && afterDiscountAmt==0){
									bootstrapValidator.updateStatus('cashOnDeliveryAmt', 'NOT_VALIDATED').validateField('cashOnDeliveryAmt'); 
								}else if((userAmt-afterDiscountAmt)<0){
									bootstrapValidator.updateStatus('cashOnDeliveryAmt', 'NOT_VALIDATED').validateField('cashOnDeliveryAmt'); 
								}
								return true;
	                        }
	                    }
	                }
	            },
	            oPhone: {
	                message: '无效手机号',
	                validators: {
	                    notEmpty: {
	                        message: '手机号不能为空'
	                    },
	                    stringLength: {
	                        min: 11,
	                        max: 11,
	                        message: '手机号长度必须是由11位数字组成'
	                    },
	                    regexp: {
	                        regexp: /^((1[3,5,8][0-9])|(14[5,7])|(17[0,6,7,8])|(19[7]))\d{8}$/,
	                        message: '手机号格式不正确'
	                    }
	                }
	            }
	        }
	    }).on('error.form.bv',function(){
		     $(".has-error:visible:first").find(":input").focus();
	   });
	});
</script>
</html>
